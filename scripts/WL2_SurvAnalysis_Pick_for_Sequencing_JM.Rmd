---
title: "WL2_Survival-Analysis"
author: "Julin Maloof"
date: 'Oct 28, 2024'
output: 
  html_document: 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## set up symbolic link

To get the data you need to create a symbolic link in `parent_pops_common-gardens/input/WL2_Data` that points to the corrected CSVs folder.  On my (JM) computer it looks like this:

```
CorrectedCSVs -> /Users/jmaloof/Library/CloudStorage/GoogleDrive-jnmaloof@ucdavis.edu/Shared drives/IntBioTeam/Common Gardens/WL2_2023/CorrectedCSVs/
```

## Libraries
```{r}
library(tidyverse)
library(janitor)
```

## Read in the data
```{r}
wl2_surv <- read_csv("../input/WL2_Data/CorrectedCSVs/WL2_mort_pheno_20231020_corrected.csv",
                     na = c("", "NA", "-", "N/A")) %>% #note this only goes to 10/20 need to come back and change this to include dates after this
  select(block:rep, death.date, survey.notes) %>% 
  rename(parent.pop=pop) %>% 
  mutate(parent.pop= str_replace(parent.pop, "Y08", "YO8")) %>% 
  mutate(parent.pop= str_replace(parent.pop, "Y04", "YO4")) %>% 
  filter(!is.na(parent.pop)) %>% 
  unite(BedLoc, bed:bed.col, sep="_", remove = FALSE) %>% 
  unite(Genotype, parent.pop:rep, sep="_", remove = FALSE) %>% 
  filter(!str_detect(Genotype, ".*buff*")) %>% 
  unite(pop.mf, parent.pop:mf, sep="_", remove = FALSE)
head(wl2_surv)
unique(wl2_surv$parent.pop)

wl2_surv %>% filter(Genotype=="CC_1_2") #there are 2 CC_1_2 plants (in different field locs), CC-1-2 was planted in 13-A and not 5C according to planting notes 
wl2_surv %>% filter(Genotype=="IH_4_5") #there are 2 IH_4_5 plants (in different field locs), IH_4_5 was planted in 22B and not 32A according to planting notes 
wl2_surv %>% rowwise() %>%  #checking if mf and rep can be converted to numeric 
  filter(!is.na(rep)) %>%  
  filter(is.na(as.numeric(rep)))
```

As weeks
```{r}
wl2_surv %>% filter(is.na(death.date),!is.na(survey.notes)) #no plants that seemed to disappear 
wl2_surv %>% filter(Genotype=="YO7_4_2")

wl2_surv_dates <- wl2_surv %>% 
  filter(BedLoc!="K_5_C") %>% 
  filter(BedLoc!="B_32_A") %>% 
  mutate(mf=as.double(mf), rep=as.double(rep)) %>% 
  mutate(planting.date="7/19/23", #could try to make this more specific to when certain blocks were planted 
         last_fup_date=if_else(is.na(death.date), "10/20/23", death.date)) %>%  #need this to calculate survival times
  mutate(planting.date=mdy(planting.date), last_fup_date=mdy(last_fup_date)) %>% #convert to date objects
  mutate(os_weeks=as.duration(planting.date %--% last_fup_date) / dweeks(1), #observed number of weeks
         status=if_else(is.na(death.date), 0, 1)) %>% #0=censured (alive in this case), 1=dead
  filter(os_weeks > 0) %>% #there is one case of a plant that was dead at planting, so just removed it since this is survival post- transplanting
  select(-survey.notes)
head(wl2_surv_dates)
unique(wl2_surv_dates$os_weeks)
```


```{r}
wl2_surv_dates %>% filter(parent.pop=="WL2") #there's a different number of WL2 plants here compared to annual census (see FirstYear Survv)
```

## Location Info
```{r}
gowersdist_UCD <- read_csv("../output/Climate/Pops_GowersEnvtalDist_UCD.csv") %>% 
  rename(Recent_Gowers_Dist_UCD = Recent_Gowers_Dist, Historic_Gowers_Dist_UCD = Historic_Gowers_Dist)
head(gowersdist_UCD)
gowersdist_WL2 <- read_csv("../output/Climate/Pops_GowersEnvtalDist_WL2.csv") %>% 
  rename(Recent_Gowers_Dist_WL2 = Recent_Gowers_Dist, Historic_Gowers_Dist_WL2 = Historic_Gowers_Dist)
head(gowersdist_WL2)

gowersdist_all <- full_join(gowersdist_UCD, gowersdist_WL2)
head(gowersdist_all)
```

```{r}
wl2_surv_dates_loc <- left_join(wl2_surv_dates, gowersdist_all) %>%
  mutate(elevation.group = factor(elevation.group, levels= c("Low", "Mid", "High")))
wl2_surv_dates_loc
```
## plot observed data

Need to summarize separately for pops and for elevation.  It is a mistake to average pops and then elevation, at least with respect to comparing to population naive models

### population-level summary
```{r}
wl2_obs.pop <- 
  wl2_surv_dates_loc %>% select(parent.pop, death.date, os_weeks, status, elevation.group) %>%
  group_by(parent.pop) %>%
  mutate(total=n()) %>%
  group_by(parent.pop, os_weeks) %>%
  summarize(n.newly.dead=sum(status),
            total=unique(total),
            elevation.group=unique(elevation.group)) %>%
  ungroup() %>%
  complete(parent.pop, os_weeks, fill = list(n.newly.dead=0)) %>% # we have missing data for weeks where nobody died and we need to fill that in
  group_by(parent.pop) %>%
  mutate(total=unique(na.omit(total)), elevation.group=unique(na.omit(elevation.group)), # filling in the blanks from the complete() step above
         total.dead=cumsum(n.newly.dead),
         surviving = total - total.dead,
         prop.surviving = surviving/total) %>%
  ungroup() %>%
#  bind_rows(week0.pop) %>%
#  select(parent.pop, elevation.group, os_weeks, prop.surviving) %>%
  arrange(parent.pop, os_weeks)

# Add a week 0 with all plants

wl2_obs.pop.0 <- wl2_obs.pop %>%
  filter(os_weeks==1) %>%
   mutate(os_weeks = 0,
          n.newly.dead = 0,
          total.dead = 0,
          surviving = total,
          prop.surviving = 1) %>%
   rbind(wl2_obs.pop) %>%
   arrange(parent.pop, os_weeks)

wl2_obs.pop.0 %>%
  ggplot(aes(x=os_weeks, y = prop.surviving, color = elevation.group)) +
  geom_smooth() +
  geom_point()

wl2_obs.pop.0 %>%
  ggplot(aes(x=os_weeks, y = prop.surviving, color = parent.pop)) +
  geom_line() +
  geom_point()
```

## Some additional summaries

```{r}
# total number of plants:
wl2_obs.pop.0 %>%
  filter(os_weeks==0) %>%
  select(parent.pop, total) %>%
  pull(total) %>% sum()
```

## select 50% of dead plants to omit per week1 and week2

```{r}
wl2_obs.pop.0 %>%
  filter(os_weeks > 0) %>%
  mutate(dead_50 = floor(n.newly.dead/2)) %>%
  group_by(os_weeks) %>%
  summarize(omit = sum(dead_50)) 
  
```

How many plants are alive at the end?

```{r}
wl2_obs.pop.0 %>%
  filter(os_weeks > 13) 

wl2_obs.pop.0 %>%
  filter(os_weeks > 13) %>%
  pull(surviving) %>%
  sum()

wl2_obs.pop.0 %>%
  filter(os_weeks > 13) %>%
  pull(total.dead) %>%
  sum()
```

# Sequencing Stratiegies:

## 50% live and 50% dead for each pop at week 7

```{r}
target.total <- 48
target.live <- ceiling(target.total * 0.50)
target.dead <- target.total - target.live

wl2_obs.pop.0 %>%
  filter(os_weeks == 7)  %>%
  select(parent.pop, total.dead, surviving) %>%
  rowwise() %>%
  mutate(seq_live = min(target.live, surviving),
         seq_dead = min(target.dead, total.dead)) %>%
  
  # add more dead if we don't have enough live plants
  mutate(seq_dead = ifelse(seq_live < target.live & total.dead > target.dead, 
                           min(target.total - seq_live, total.dead),
                           seq_dead),
         seq_live = ifelse(seq_dead < target.dead & surviving > target.live,
                           min(target.total - seq_dead, surviving),
                           seq_live)
         ) %>%
  adorn_totals() %>% knitr::kable(caption = "50% / 50% split")
```

## 60% live and 40% dead for each pop at week 7

```{r}
target.total <- 48
target.live <- 29
target.dead <- target.total - target.live

tmp <- wl2_obs.pop.0 %>%
  filter(os_weeks == 7)  %>%
  select(parent.pop, total.dead, surviving) %>%
  rowwise() %>%
  mutate(seq_live = min(target.live, surviving),
         seq_dead = min(target.dead, total.dead)) %>%
  
  # add more dead if we don't have enough live plants
  mutate(seq_dead = ifelse(seq_live < target.live & total.dead > target.dead, 
                           min(target.total - seq_live, total.dead),
                           seq_dead),
         seq_live = ifelse(seq_dead < target.dead & surviving > target.live,
                           min(target.total - seq_dead, surviving),
                           seq_live)
         ) 

tmp %>% adorn_totals() %>% knitr::kable(caption = "Target: n=29 live")

sum(tmp$seq_live, tmp$seq_dead)

```
## 70% live and 30% dead for each pop at week 7

```{r}
target.total <- 48
target.live <- floor(target.total*.7)
target.dead <- target.total - target.live

tmp <- wl2_obs.pop.0 %>%
  filter(os_weeks == 7)  %>%
  select(parent.pop, total.dead, surviving) %>%
  rowwise() %>%
  mutate(seq_live = min(target.live, surviving),
         seq_dead = min(target.dead, total.dead)) %>%
  
  # add more dead if we don't have enough live plants
  mutate(seq_dead = ifelse(seq_live < target.live & total.dead > target.dead, 
                           min(target.total - seq_live, total.dead),
                           seq_dead),
         seq_live = ifelse(seq_dead < target.dead & surviving > target.live,
                           min(target.total - seq_dead, surviving),
                           seq_live)
         ) 

tmp %>% adorn_totals() %>% knitr::kable(caption = "Target: 70% live, week 7")

sum(tmp$seq_live, tmp$seq_dead)

```

## As many live plants as possible week 13

```{r}
target.total <- 48
target.live <- target.total
target.dead <- target.total - target.live

tmp <- wl2_obs.pop.0 %>%
  filter(os_weeks > 13)  %>%
  select(parent.pop, total.dead, surviving) %>%
  rowwise() %>%
  mutate(seq_live = min(target.live, surviving),
         seq_dead = min(target.dead, total.dead)) %>%
  
  # add more dead if we don't have enough live plants
  mutate(seq_dead = ifelse(seq_live < target.live & total.dead > target.dead, 
                           min(target.total - seq_live, total.dead),
                           seq_dead),
         seq_live = ifelse(seq_dead < target.dead & surviving > target.live,
                           min(target.total - seq_dead, surviving),
                           seq_live)
         )

sum(tmp$seq_dead, tmp$seq_live)

tmp %>% adorn_totals() %>% knitr::kable(caption = "max live plants week 13")
```

